# Disaster Recovery (личный сервис)

Цель: если сервер “умер”, диск сломался или сервер взломали/испортил данные — ты должен **быстро поднять сервис** и **восстановить vault** имея:

- **`vault.db` (или бэкап .db)** с сервера
- **мастер‑пароль пользователя**

## Что важно понимать (zero‑knowledge)

- Сервер хранит только:
  - `vault_ciphertext`, `vault_nonce`
  - `kdf_salt`, `kdf_params`
  - `vault_version`
- Без мастер‑пароля содержимое vault расшифровать нельзя.
- Если злоумышленник украдёт БД — он получит шифртекст + соль/параметры (материал для офлайн‑брутфорса слабых паролей).

## Где лежит БД

- По умолчанию: `data/vault.db`
- Рядом могут быть WAL файлы: `data/vault.db-wal`, `data/vault.db-shm` (это нормально).

## Как делать бэкапы БД (правильно для WAL)

Команда создаёт консистентный backup через SQLite Online Backup API:

```bash
npm run db:backup
```

Бэкапы складываются в папку `backups/`:

- `backups/vault-YYYY-MM-DDTHH-MM-SS-sssZ.db`

Рекомендуемый режим (личный сервис):

- ежедневно + перед обновлениями/деплоем
- хранить 7–30 последних файлов
- копию `backups/` держать отдельно от сервера (внешний диск/второй VPS).  
  (Файл всё равно шифртекст, но логины остаются метаданными.)

## Восстановление на новом сервере

1) Развернуть код (git clone), установить зависимости:

```bash
npm install
npm run build
```

2) Положить `vault.db` в `data/vault.db` (или восстановить командой):

```bash
npm run db:restore -- backups/vault-<timestamp>.db
```

3) Запустить:

```bash
npm start
```

4) На клиенте:

- Unlock → вводишь login + мастер‑пароль → vault расшифруется.

## Если сервер взломали

Минимальный сценарий (быстро вернуть сервис):

- поднять новый сервер из чистого образа
- восстановить **из последнего известного чистого** `backups/vault-*.db`
- поменять домен/ключи сервера/пароли доступа к VPS

Важно: так как это zero‑knowledge, компрометация сервера ≠ компрометация vault, **если** мастер‑пароль был сильным.

Рекомендуемая реакция:

- сменить мастер‑пароль (нужно будет добавить UI “Change master password”: decrypt → re-encrypt новым паролем)
- поднять rate-limit и CSP (см. TODO в проекте)


